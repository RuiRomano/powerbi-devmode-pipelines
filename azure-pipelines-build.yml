variables:
  - name: 'datasetPath'
    value: 'Sales.Dataset\Model.bim'
  - name: 'reportPath'
    value: 'Sales.Report'


trigger: none

pool:
  vmimage: 'windows-latest'

stages:
 - stage: Build_DataSets
   jobs:
    - job: Build
      steps:
        - checkout: self
          path: 'self'
        - task: PowerShell@2
          displayName: 'Download TE'
          inputs:
            targetType: inline
            script: |
              $path = "$(Build.SourcesDirectory)"
              $toolsPath = "$path\_Tools"
              $TabularEditorUrl = "https://github.com/otykier/TabularEditor/releases/download/2.18.2/TabularEditor.Portable.zip" 
              $zipFile = "$path\TabularEditor.zip"
              Invoke-WebRequest -Uri $TabularEditorUrl -OutFile $zipFile
              Expand-Archive -Path $zipFile -DestinationPath $toolsPath -Force
              Remove-Item $zipFile
              Write-Host "Tools path: $toolsPath"          
        - task: PowerShell@2
          displayName: 'Download PBIXInspector'
          inputs:
            targetType: inline
            script: |
              $path = "$(Build.SourcesDirectory)"
              $toolsPath = "$path\_Tools"
              $downloadUrl = "https://github.com/NatVanG/PBIXInspector/releases/download/v1.7.1-CLI/win-x64-v1.7.1-CLI.zip" 
              $zipFile = "$path\PBIXInspector.zip"
              Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
              Expand-Archive -Path $zipFile -DestinationPath $toolsPath -Force
              Remove-Item $zipFile
              Write-Host "Tools path: $toolsPath"

        - task: PowerShell@2
          displayName: 'Run Dataset Rules'
          inputs:
            targetType: inline
            script: |
              $path = "$(Build.SourcesDirectory)"
              $toolPath = "$path\_Tools\TabularEditor.exe"
              $rulesPath = "$path\Rules-Dataset.json"
              $datasetPath = "$path\$(datasetPath)"

              Start-Process -FilePath "$toolPath" -ArgumentList """$datasetPath"" -A ""$rulesPath"" -V" -NoNewWindow -Wait

        - task: PowerShell@2
          displayName: 'Run Report Rules'
          inputs:
            targetType: inline
            script: |
              $path = "$(Build.SourcesDirectory)"
              $toolPath = "$path\_Tools\win-x64\CLI\PBIXInspectorCLI.exe"
              $rulesPath = "$path\Rules-Report.json"
              $reportPath = "$path\$(reportPath)"

              Start-Process -FilePath "$toolPath" -ArgumentList "-pbipreport ""$reportPath"" -rules ""$rulesPath"" -formats ""ADO""" -NoNewWindow -Wait